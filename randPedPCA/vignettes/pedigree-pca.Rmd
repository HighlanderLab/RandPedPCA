---
title: "Pedigree PCA"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{pedigree-pca}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(randPedPCA)
```

# Intro
Principal component analysis (PCA) is a method for summarising the information
in the columns of a matrix. Because pedigrees can be represented as matrices,
they can, in principle, be subjected to PCA.

When thinking about PCA,
one usually begins with a data matrix, such as the iris dataset, whose rows represent
individuals or observations and whose columns contain traits, features, or markers. However, when
dealing with a pedigree-derived matrix, there is no data matrix of this kind. For
instance, a pedigree's additive relationship matrix **A** is a covariance matrix.
Fortunately, PCA can also be achieved by starting from a covariance matrix. That is what
the randPedPCA package does.

In this vignette, we demonstrate how to use the package randPedPCA and how to
carry out PCA on your own pedigree or pedigree matrix.

## Pedigree input
Using an example dataset that ships with **`randPedPCA`**, called `pedMeta`, we first generate a pedigree object. This is done using the function `pedigree` from the dependence **`pedigreeTools`**.
Then we use `rppca` to perform PCA. Ignore the deprecation warning about matrix conversion if one comes up.
Unfortunately the suggested code does not work.
```{r}
# generate a pedigree object from the shipped example dataset
ped <- pedigree(pedMeta$fid,
                pedMeta$mid,
                pedMeta$id)
pc01 <- rppca(ped, center=T)
plot(pc01$x[,1:2], col = pedMeta$population)
```


## Matrix input
Instead of starting from a pedigree, we can also use the pedigree's L inverse matrix
as the input to `rppca`. This matrix can be generated using the `getLInv` function
from **`pedigreeTools`**. Note that `rppca` expects a sparse matrix
in `spam` format. This is why we wrap `sparse2spam` around `getLInv`:
```{r}
li <- sparse2spam(getLInv(ped))
pc02 <- rppca(li, center = T)
plot(pc02$x[,1:2], col = pedMeta$population)
```

For simplicity, we decided to ship this L inverse matrix as an example dataset.
The PCA result is identical when using this object `pedLinv`:
```{r}
pc03 <- rppca(pedLInv, center = T)
plot(pc03$x[,1:2], col = pedMeta$population)
```

## Variance components
When running PCA, users often care about how much variance and what
proportion of the total variance is accounted for by individual principal
components. This can be queried using the `summary` function on a PCA object. For
objects generated by `rppca`, this will return the standard deviation of each PC.
If the input to `rppca` was a pedigree object and the `center` paramter
is set to `FALSE` (the default), then there will be two additional 
rows: the proportion of total variance and their cumulative sum.
R users may be used to this behaviour from the built-in functions `prcomp` and
`princomp`.

The reason that the variance proportions and cumulative sums are not shown by default
is that these numbers are costly to estimate from a large L inverse matrix.
If the total variance is known, it can be specified when running `rppca` using
the argument `totVar`.

### Examples
The summary of a PCA generated from an L inverse matrix by default only shows
the standard deviation accounted for by each PC. I also throws a warning saying
that there is no information about the total variance:
```{r}
summary(pc02)
```

When starting from a pedigree and with no centring, then variance proportions and
cumulative sums are returned as well:
```{r}
pc04 <- rppca(ped, center=F)
summary(pc04)
```


If the user has an estimate of the total variance, it can be supplied when calling
`rppca` on a matrix object and the variance proportions and cumulative sums are returned:
```{r}
pc05 <- rppca(pedLInv, center=F, totVar=3521.534)
summary(pc05)
```

This can also be done when using pedigree input but with centring:
```{r}
pc06 <- rppca(ped, center=T, totVar=2694.038)
summary(pc06)
```

When running `rppca` on a pedigree object without centring, totVar can be used
to override the value computed from the pedigree. This triggers a warning. In this
case here, it also causes variance proportions > 1 which do not make sense:
```{r}
pc07 <- rppca(ped, center=F, totVar=123)
summary(pc07)
```


# Using one's own data
Users will mainly want to analyse their own empirical or simulated datasets. This
should be straightforward if the data are in pedigree format. In this case, `rppca`
can be called directly in such an object as demonstrated above. 

If the user has an L inverse matrix, this needs to be converted into 
a `spam` object, a specific sparse matrix format. We provide a wrapper
called `importLinv` for reading
matrices in Matrix Market format from disk an converting these into `spam` format.
If a sparse L inverse matrix is already available in in the workspace, `sparse2spam`
should work to convert it to `spam` format. Let us know if this does not work for
you (and please share a reproducible example)!
